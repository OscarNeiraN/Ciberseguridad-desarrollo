pipeline {
    agent any

    environment {
        VENV = "venv"
    }

    options {
        timestamps()          
        ansiColor('xterm')    
    }

    stages {

        stage('Prepare') {
            steps {
                echo "Creando entorno virtual y actualizando pip..."
                sh """
                    python3 -m venv $VENV
                    . $VENV/bin/activate
                    pip install --upgrade pip wheel setuptools
                """
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "Instalando dependencias..."
                sh """
                    . $VENV/bin/activate
                    pip install -r requirements.txt
                """
            }
        }

        stage('Unit Tests') {
            steps {
                echo "Ejecutando tests..."
                sh """
                    . $VENV/bin/activate
                    pytest --maxfail=1 --disable-warnings --cache-clear || true
                """
            }
            post {
                always {
                    junit '**/pytest-report.xml'
                }
            }
        }

        stage('Security Scan - Bandit') {
            steps {
                echo "Ejecutando análisis SAST (Bandit)..."
                sh """
                    . $VENV/bin/activate
                    pip install bandit
                    bandit -r . -f json -o bandit_report.json || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'bandit_report.json'
                }
            }
        }

        stage('Security Scan - Safety') {
            steps {
                echo "Analizando dependencias vulnerables..."
                sh """
                    . $VENV/bin/activate
                    pip install safety
                    safety check -o safety_report.txt || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'safety_report.txt'
                }
            }
        }

        stage('Build Flask App') {
            steps {
                echo "Verificando estructura del proyecto Flask..."
                sh """
                    . $VENV/bin/activate
                    python -m py_compile vulnerable_app.py
                """
            }
        }

        stage('Package') {
            steps {
                echo "Empaquetando aplicación para despliegue..."
                sh """
                    mkdir -p dist
                    cp -r vulnerable_app.py templates static requirements.txt dist/
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'dist/**'
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                echo "Desplegando aplicación Flask a AWS EC2..."
                sh """
                    scp -o StrictHostKeyChecking=no -i /path/to/key.pem -r dist/* ec2-user@EC2_PUBLIC_IP:/var/www/flaskapp/
                    ssh -o StrictHostKeyChecking=no -i /path/to/key.pem ec2-user@EC2_PUBLIC_IP 'sudo systemctl restart flaskapp'
                """
            }
        }
    }

    post {
        always {
            echo "Pipeline completado. Limpiando entorno virtual."
            sh "rm -rf $VENV"
        }
    }
}
