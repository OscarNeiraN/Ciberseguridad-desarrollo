pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "oneiran/securedev:latest"
        EC2_USER = "ec2-user"
        EC2_IP = "44.211.117.60"
        EC2_KEY = "jenkins/claves-jenkins-ubuntu.pem"
        SNYK_TOKEN = credentials('snyk-token')
    }

    stages {

        /* ==========================
         * CHECKOUT
         * ========================== */
        stage('Checkout') {
            steps {
                git branch: 'main',
                    credentialsId: 'github-creds',
                    url: 'https://github.com/OscarNeiraN/Ciberseguridad-desarrollo.git'
            }
        }

        /* ==========================
         * VIRTUAL ENV
         * ========================== */
        stage('Install Dependencies') {
            steps {
                sh """
                    echo "Creando entorno virtual..."
                    python3 -m venv venv

                    echo "Instalando dependencias..."
                    ./venv/bin/pip install --upgrade pip
                    ./venv/bin/pip install -r requirements.txt
                """
            }
        }

        /* ==========================
         * BANDIT
         * ========================== */
        stage('Bandit Security Scan') {
            steps {
                sh """
                    echo "Ejecutando Bandit..."
                    ./venv/bin/bandit -r . -f json -o bandit-report.json || true
                    ./venv/bin/bandit -r . -f html -o bandit-report.html || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'bandit-report.*', fingerprint: true
                }
            }
        }

        /* ==========================
         * SNYK CODE
         * ========================== */
        stage('Snyk Code Scan (SAST)') {
            steps {
                sh """
                    snyk auth ${SNYK_TOKEN}
                    echo "Ejecutando Snyk Code..."
                    snyk code test --json > snyk-code.json || true
                    snyk code test --sarif > snyk-code.sarif || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'snyk-code.*', fingerprint: true
                }
            }
        }

        /* ==========================
         * SNYK DEPENDENCIAS
         * ========================== */
        stage('Snyk Dependency Scan') {
            steps {
                sh """
                    echo "Analizando dependencias..."
                    snyk test --json > snyk-deps.json || true
                    snyk test --sarif > snyk-deps.sarif || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'snyk-deps.*', fingerprint: true
                }
            }
        }

        /* ==========================
         * SNYK CONTENEDOR
         * ========================== */
        stage('Snyk Container Scan') {
            steps {
                sh """
                    docker build -t ${DOCKER_IMAGE} .
                    snyk container test ${DOCKER_IMAGE} --json > snyk-container.json || true
                    snyk container test ${DOCKER_IMAGE} --sarif > snyk-container.sarif || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'snyk-container.*', fingerprint: true
                }
            }
        }

        /* ==========================
         * OWASP ZAP ACTIVE SCAN + AUTH
         * ========================== */
        stage('OWASP ZAP Active Scan') {
            steps {
                sh """
                    echo "Iniciando aplicación Flask temporal..."
                    nohup ./venv/bin/python app.py > flask.log 2>&1 &
                    echo $! > flask.pid

                    echo "Esperando que Flask inicie..."
                    CURL_TARGET="http://127.0.0.1:5000"
                    for i in {1..20}; do
                        if curl -s "$CURL_TARGET" >/dev/null; then
                            echo "Flask está corriendo!"
                            READY=1
                            break
                        fi
                        sleep 2
                    done

                    if [ "${READY:-0}" -eq 1 ]; then
                        echo "Creando usuario de prueba en la base de datos..."
                        ./venv/bin/python3 - <<'EOF'
import sqlite3
conn = sqlite3.connect('instance/app.db')
c = conn.cursor()
c.execute("INSERT OR IGNORE INTO users (email, password) VALUES (?, ?)",
          ("testuser@example.com", "TestPassword123"))
conn.commit()
conn.close()
EOF

                        echo "Generando zap.yaml..."
                        cat > zap.yaml <<EOF
env:
  contexts:
  - name: auth-context
    urls:
      - $CURL_TARGET
    authentication:
      method: formBasedAuthentication
      parameters:
        loginPageUrl: $CURL_TARGET/login
        loginRequestUrl: $CURL_TARGET/rest/user/login
        loginRequestBody: '{"email":"testuser@example.com","password":"TestPassword123"}'
      verification:
        method: poll
        pollFrequency: 2
        pollUrl: $CURL_TARGET/dashboard
        pollPostData: ""
    users:
      - name: testuser
        credentials:
          email: testuser@example.com
          password: TestPassword123
jobs:
- type: spider
  parameters:
    url: $CURL_TARGET
    maxDuration: 2
- type: activeScan
  parameters:
    url: $CURL_TARGET
    maxDuration: 5
- type: report
  parameters:
    reportDir: /zap/wrk/
    reportFile: zap_report.html
    reportTitle: ZAP Authenticated Active Scan Report
    template: traditional-html
- type: report
  parameters:
    reportDir: /zap/wrk/
    reportFile: zap_report.json
    reportTitle: ZAP Authenticated Active Scan Report
    template: traditional-json
EOF

                        echo "Ejecutando ZAP con Automation Framework..."
                        docker run --rm --network=host \\
                            -v "$(pwd)":/zap/wrk/:rw \\
                            ghcr.io/zaproxy/zaproxy:stable \\
                            zap.sh -cmd -autorun /zap/wrk/zap.yaml || true
                    else
                        echo "ADVERTENCIA: Flask no respondió. Saltando ZAP."
                    fi
                """
            }
            post {
                always {
                    sh """
                        if [ -f flask.pid ]; then
                            PID=\$(cat flask.pid)
                            echo "Deteniendo Flask PID: \$PID"
                            kill "\$PID" || true
                            rm -f flask.pid
                        fi
                    """
                    archiveArtifacts artifacts: 'zap_report.*, flask.log', fingerprint: true
                }
            }
        }

        /* ==========================
         * PUSH DOCKER
         * ========================== */
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                        docker push ${DOCKER_IMAGE}
                    """
                }
            }
        }

        /* ==========================
         * DEPLOY EN EC2
         * ========================== */
        stage('Deploy to EC2') {
            steps {
                sh """
                    chmod 400 ${EC2_KEY}
                    ssh -o StrictHostKeyChecking=no -i ${EC2_KEY} ${EC2_USER}@${EC2_IP} '
                        docker stop app || true
                        docker rm app || true
                        docker pull ${DOCKER_IMAGE}
                        docker run -d --restart always --name app -p 80:5000 ${DOCKER_IMAGE}
                    '
                """
            }
        }
    }

    post {
        always {
            echo "Pipeline completado. Todos los reportes fueron archivados."
        }
    }
}