pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "oneiran/securedev:latest"
        EC2_USER = "ec2-user"
        EC2_IP = "3.239.5.93"
        EC2_KEY = "jenkins/claves-jenkins-ubuntu.pem"
    }

    stages {

        /* ==========================
         *      CHECKOUT CÃ“DIGO
         * ========================== */
        stage('Checkout') {
            steps {
                git branch: 'main',
                    credentialsId: 'github-creds',
                    url: 'https://github.com/TU_USUARIO/TU_REPO.git'
            }
        }

        /* ==========================
         *       VIRTUAL ENV
         * ========================== */
        stage('Install Dependencies') {
            steps {
                sh """
                    echo "Creando entorno virtual..."
                    python3 -m venv venv

                    echo "Activando entorno virtual..."
                    source venv/bin/activate

                    echo "Instalando dependencias..."
                    pip install --upgrade pip
                    pip install -r requirements.txt
                """
            }
        }

        /* ==========================
         *      BANDIT SCAN
         * ========================== */
        stage('Bandit Security Scan') {
            steps {
                sh """
                    echo "Ejecutando Bandit..."
                    ~/.local/bin/bandit -r . || true
                """
            }
        }

        /* ==========================
         *      SNYK SCANS
         * ========================== */
        stage('Snyk Code Scan') {
            environment {
                SNYK_TOKEN = credentials('snyk-token')
            }
            steps {
                sh """
                    echo "Autenticando Snyk..."
                    snyk auth \$SNYK_TOKEN

                    echo "Ejecutando Snyk Code..."
                    snyk code test || true
                """
            }
        }

        stage('Snyk Dependency Scan') {
            environment {
                SNYK_TOKEN = credentials('snyk-token')
            }
            steps {
                sh """
                    snyk test || true
                """
            }
        }

        /* ==========================
         *     DOCKER BUILD & PUSH
         * ========================== */
        stage('Build Docker Image') {
            steps {
                sh """
                    echo "Construyendo imagen Docker..."
                    docker build -t ${DOCKER_IMAGE} .
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-creds',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo "Haciendo login en Docker Hub..."
                        echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin

                        echo "Pushing image..."
                        docker push ${DOCKER_IMAGE}
                    """
                }
            }
        }

        /* ==========================
         *         DEPLOY EN EC2
         * ========================== */
        stage('Deploy to EC2') {
            steps {
                sh """
                    echo "Preparando llave EC2..."
                    chmod 400 ${EC2_KEY}

                    echo "Desplegando en EC2..."
                    ssh -o StrictHostKeyChecking=no -i ${EC2_KEY} ${EC2_USER}@${EC2_IP} '
                        echo "Deteniendo contenedor previo..."
                        docker stop app || true
                        docker rm app || true

                        echo "Actualizando imagen..."
                        docker pull ${DOCKER_IMAGE}

                        echo "Iniciando contenedor..."
                        docker run -d --name app -p 80:5000 ${DOCKER_IMAGE}
                    '
                """
            }
        }
    }
}
